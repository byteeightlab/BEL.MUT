/* Mutation [BEL.MUT] v0.1 | byteeightlab.ru/#MUT | GNU General Public License v3.0 | byteeightlab.ru/source/bel_mut/LICENSE */
(()=>{let b=function(e,s,t){if("object"!=typeof t||t.__proto__!=Object.prototype)return e(!0);let r=JSON.parse(JSON.stringify(t)),i=null,a={attributes:!0,attributeFilter:[]},o={},n={},l=!1,u=!1,c=async t=>!!this.mutationPromise&&(this.mutationStop=t=>null,i&&i.disconnect(),r.trigger&&!u&&this.dispatchEvent(new CustomEvent("mutationComplete",{detail:{element:this,trigger:r.trigger,performed:t}})),!0===t&&this.mutationPromise&&this.mutationPromise.queue&&this.mutationPromise.queue.length?b.call(this,e,s,this.mutationPromise.queue.shift()):(this.mutationPromise=null,void e(t)));if(this.mutationStop=t=>(u=!0,c(!1)),r.duration)if("function"==typeof r.duration){let e=r.duration;r.duration={function:t=>(t=parseInt(e(t),10),isNaN(t)?0:t)}}else"number"!=typeof r.duration?(r.duration.at&&"%"==r.duration.at(-1)?r.duration={percent:parseFloat(r.duration)}:r.duration={number:parseInt(r.duration,10)},isNaN(r.duration.percent)&&delete r.duration):r.duration={number:r.duration};for(var m in r)switch(m){case"style":if("object"!=typeof r.style||r.style.__proto__!=Object.prototype)delete r.style;else{var d,y=document.createElement("span").style;for(d in y.cssText=this.style.cssText,r.style)null!=y[d]?y[d]=r.style[d]:y.setProperty(d,r.style[d]);r.style=y,a.attributeFilter.push("style"),o.style=Object.assign({},this.style),o.style.cssText=this.style.cssText,o.style.attributeValue=this.getAttribute("style");for(let t=0,e=r.style.length;t<e;t++){var p=r.style[t];r.style[p]==o.style[p]&&delete r.style[p]}}break;case"class":if("object"!=typeof r.class||r.class.__proto__!=Object.prototype)delete r.class;else if(r.class.add&&Array.isArray(r.class.add)||delete r.class.add,r.class.remove&&Array.isArray(r.class.remove)||delete r.class.remove,r.class.add||r.class.remove){if(r.class.add&&r.class.remove){var h,f=r.class.remove.filter(t=>r.class.add.includes(t));for(let t=0,e=f.length;t<e;t++)0<=(h=r.class.remove.indexOf(f[t]))&&(r.class.remove=r.class.remove.slice(0,h).concat(r.class.remove.slice(h+1)))}a.attributeFilter.push("class"),o.class=Array.from(this.classList),r.class.remove?n.class=o.class.filter(t=>!r.class.remove.includes(t)):n.class=[],r.class.add&&(n.class=[...new Set([...n.class,...r.class.add])])}else delete r.class}if(0==a.attributeFilter.length)l=!1;else for(var v in(i=new MutationObserver(async(t,e)=>{if(!this.mutationPromise)return!1;let s=!0,i=0;for(var a in r)switch(a){case"style":this.style.cssText!=r.style.cssText&&(s=!1);break;case"class":for(let t=0,e=r.class.length;t<e;t++)if(!this.classList.classList.contains(r.class[t])){s=!1;break}}s&&(i=this.mutationDuration,r.duration&&(r.duration.function?i=r.duration.function(i):r.duration.number?0<r.duration.number?i=r.duration.number:i-=r.duration.number:r.duration.percent&&(0<r.duration.percent?i=i/100*r.duration.percent:i+=i/100*r.duration.percent)),0<i&&await g(i),u||c(!0))})).observe(this,a),r)switch(v){case"style":this.style.cssText=r.style.cssText,o.style.cssText!=this.style.cssText?l=!0:delete r.style;break;case"class":r[v].remove&&this.classList.remove(...r[v].remove),r[v].add&&this.classList.add(...r[v].add);let e=Array.from(this.classList);0<o.class.filter(t=>!e.includes(t)).concat(e.filter(t=>!o.class.includes(t))).length?l=!0:delete r.class}l||(r.trigger&&this.dispatchEvent(new CustomEvent("mutationComplete",{detail:r.trigger})),c(!0))},g=s=>new Promise((e,t)=>setTimeout(t=>e(),s??1e3));Element.prototype.mutation=async function(s){return this.mutationPromise?(this.mutationPromise.queue?this.mutationPromise.queue.push(s):this.mutationPromise.queue=[s],this.mutationPromise):this.mutationPromise=new Promise(async(t,e)=>{b.call(this,t,e,s)})},Element.prototype.mutationStop=t=>null,Element.prototype.mutationPromise=null,Element.prototype.__defineGetter__("mutationDuration",function(){let t=window.getComputedStyle(this),e=parseFloat(t.animationDuration),s=parseFloat(t.animationDelay),i=parseInt(t.animationIterationCount,10),a=parseFloat(t.transitionDuration),r=parseFloat(t.transitionDelay);return isNaN(e)&&(e=0),isNaN(s)&&(s=0),isNaN(i)&&(i=0),isNaN(a)&&(a=0),isNaN(r)&&(r=0),a=r+a,e=s+e*i,1e3*(a>e?a:e)}),NodeList.prototype.mutation=function(e){let s=[];return this.forEach(t=>{s.push(t.mutation(e))}),Promise.all(s)},NodeList.prototype.mutationStop=function(){this.forEach(t=>t.mutationStop())}})();